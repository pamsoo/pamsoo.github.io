---
title: Manila × CephFS × NFS-Ganesha 구성 (1)
tags: manila cephfs nfs-ganesha
---

___이 포스트는 GitHub 블로그 테스트를 겸하여 작성하고 있습니다. 아직 완성된 문서가 아닙니다.___

## Manila 설치

### 사전 작업

1. Database 생성

    - DBMS 접속

        ```
        mysql -uroot -p
        ```

    - ___`manila`___ DB 생성

        ```
        CREATE DATABASE manila;
        ```

    - DB 권한 설정

        아래 코드 중 ___`MANILA_DBPASS`___ 는 배포하는 환경에 맞게 변경해야 합니다.

        ```
        GRANT ALL PRIVILEGES ON manila.* TO 'manila'@'localhost' \
          IDENTIFIED BY 'MANILA_DBPASS';
        GRANT ALL PRIVILEGES ON manila.* TO 'manila'@'%' \
          IDENTIFIED BY 'MANILA_DBPASS';
        ```

2. OpenStack 서비스 설정

    - CLI 명령을 위해 admin 환경 파일 적용

        ```
        source openrc
        ```

    - 사용자 및 서비스 생성

        ```
        openstack user create --domain default --password-prompt manila
        openstack role add --project service --user manila admin
        ```
        ```
        openstack service create --name manila \
          --description "OpenStack Shared File Systems" share
        ```
        ```
        openstack service create --name manilav2 \
          --description "OpenStack Shared File Systems V2" sharev2
        ```

    - 서비스 Endpoint 생성

        아래 코드 중 ___`CONTROLLER`___ 는 배포하는 환경에 맞게 변경해야 합니다.

        ```
        openstack endpoint create --region RegionOne \
          share public http://CONTROLLER:8786/v1/%\(tenant_id\)s
        openstack endpoint create --region RegionOne \
          share internal http://CONTROLLER:8786/v1/%\(tenant_id\)s
        openstack endpoint create --region RegionOne \
          share admin http://CONTROLLER:8786/v1/%\(tenant_id\)s
        ```
        ```
        openstack endpoint create --region RegionOne \
          sharev2 public http://CONTROLLER:8786/v2/%\(tenant_id\)s
        openstack endpoint create --region RegionOne \
          sharev2 internal http://CONTROLLER:8786/v2/%\(tenant_id\)s
        openstack endpoint create --region RegionOne \
          sharev2 admin http://CONTROLLER:8786/v2/%\(tenant_id\)s
        ```

3. 메시지큐 설정

    Manila 컴포넌트는 OpenStack의 다른 컴포넌트와 마찬가지로 메시지큐를 사용합니다. RabbitMQ를 사용하는 경우 아래와 같은 단계로 사용자와 가상호스트를 생성하고, 권한을 부여합니다.
    아래 코드 중 ___`MANILA_MQPASS`___ 는 배포하는 환경에 맞게 변경해야 합니다.

    ```
    rabbitmqctl add_user manila MANILA_MQPASS
    ```
    ```
    rabbitmqctl add_vhost /manila
    ```
    ```
    rabbitmqctl set_permissions -p /manila manila ".*" ".*" ".*"
    ```

### 본 작업

Manila 소스 코드를 사용하여 파이썬 가상 환경(Virtual Environment)에 설치합니다. API를 제공하는 manila-api 서비스는 uWSGI를 사용합니다.

1. Manila 설치 준비

    - 파이썬 가상 환경 생성

        여기서는 사용하는 가상 환경 경로는 `/openstack/venvs/manila`입니다. 이후의 각종 설정 파일에서도 이 경로를 사용합니다. 배포하는 환경에 맞게 변경할 수 있습니다.

        ```
        pip install virtualenv
        ```
        ```
        virtualenv /openstack/venvs/manila
        source /openstack/venvs/manila/bin/activate
        ```

    - 필수 패키지 설치
        ```
        pip install uwsgi PyMySQL
        ```

2. Manila 설치

    - Manila 소스 코드 다운로드 및 설치

        ```
        git clone -b stable/queens https://opendev.org/openstack/manila /opt/
        pip install -r requirements.txt /opt/manila
        ```

    - 서비스 전용 사용자 생성

        ```
        useradd -r -s /bin/false -d /noexistent -c "manila system user" manila
        ```

    - 사용자 sudoer 권한 설정

        ```
        vi /etc/sudoers.d/manila_sudoers
        ```

        > ```
        > Defaults:manila !requiretty
        > Defaults:manila secure_path="/openstack/venvs/manila/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
        > 
        > manila ALL = (root) NOPASSWD: /openstack/venvs/manila/bin/manila-rootwrap
        > ```

3. Manila 설정

    - 동작 디렉토리 생성

        `mkdir` 후 `chown`으로 같은 결과를 얻을 수 있지만, `install` 명령을 사용하여 한번에 작업할 수 있습니다.

        ```
        install -d -m 0755 -o manila -g manila /var/lib/manila \
                                               /var/lock/manila \
                                               /var/log/manila \
                                               /var/run/manila-api
        ```

        `/var/run`, `/var/lock` 디렉토리는 각각 `../run`, `../run/lock`으로 링크되어 있으며, `/run`은 `df` 명령으로 확인해보면 임시 파일시스템(tmpfs)에 마운트되어 있습니다. 따라서 시스템을 재부팅하면 특별히 조치하지 않는 이상 `/var/run`과 `/var/lock` 디렉토리 안의 모든 파일이 삭제됩니다. 시스템이 재부팅되는 경우 수행해야 할 디렉토리 생성 과정을 자동화하기 위하여 아래와 같이 설정합니다.

        ```
        vi /etc/tmpfiles.d/openstack-manila-api.conf
        ```
        > ```
        > D /var/run/manila-api 2755 manila manila
        > ```
        ```
        vi /etc/tmpfiles.d/openstack-manila-share.conf
        ```
        > ```
        > D /var/lock/manila 2755 manila manila
        > ```
    
    - uWSGI 설정

        ```
        mkdir -p /etc/uwsgi
        vi /etc/uwsgi/manila-api.ini
        ```
        > ```
        > [uwsgi]
        > uid = manila
        > gid = manila
        > 
        > virtualenv = /openstack/venvs/manila
        > wsgi-file = /openstack/venvs/manila/bin/manila-wsgi
        > http = 0.0.0.0:8786
        > 
        > master = true
        > enable-threads = true
        > processes = 16
        > threads = 1
        > exit-on-reload = false
        > die-on-term = true
        > lazy-apps = true
        > add-header = Connection: close
        > buffer-size = 65535
        > thunder-lock = true
        > logfile-chmod = 644
        > pidfile = /var/run/manila-api/manila-api.pid
        > 
        > # Avoid filling up the logs with health check requests from haproxy.
        > route-user-agent = ^osa-haproxy-healthcheck$ donotlog:
        > ```

    - 설정 파일 디렉토리 생성

        ```
        cp -r /opt/manila/etc/manila /etc/
        chown manila:manila /etc/manila
        chown root:manila /etc/manila/*
        chown -R root:root /etc/manila/rootwrap.d
        ```
    
    - Rootwrap 설정

        `exec_dirs` 항목에 파이썬 가상 환경 경로로 만든 `/openstack/venvs/manila/bin`을 추가합니다. 그 밖의 내용은 원본 파일과 같습니다.

        ```
        vi /etc/manila/rootwrap.conf
        ```
        > ```
        > # Configuration for manila-rootwrap
        > # This file should be owned by (and only-writeable by) the root user
        > 
        > [DEFAULT]
        > # List of directories to load filter definitions from (separated by ',').
        > # These directories MUST all be only writeable by root !
        > filters_path=/etc/manila/rootwrap.d,/usr/share/manila/rootwrap
        > 
        > # List of directories to search executables in, in case filters do not
        > # explicitly specify a full path (separated by ',')
        > # If not specified, defaults to system PATH environment variable.
        > # These directories MUST all be only writeable by root !
        > exec_dirs=/openstack/venvs/manila/bin,/sbin,/usr/sbin,/bin,/usr/bin,/usr/local/sbin,/usr/local/bin
        > 
        > # Enable logging to syslog
        > # Default value is False
        > use_syslog=False
        > 
        > # Which syslog facility to use.
        > # Valid values include auth, authpriv, syslog, user0, user1...
        > # Default value is 'syslog'
        > syslog_log_facility=syslog
        > 
        > # Which messages to log.
        > # INFO means log all usage
        > # ERROR means only log unsuccessful attempts
        > syslog_log_level=ERROR
        > ```

    - manila.conf 설정

        ```
        vi /etc/manila/manila.conf
        ```
        > ```
        > [DEFAULT]
        > use_journal = False
        > # Disable stderr logging
        > use_stderr = False
        > debug = False
        > fatal_deprecations = False
        > my_ip = MANILA_NODE_IP  # Internal
        > 
        > default_share_type = nfs
        > share_name_template = share-%s
        > 
        > osapi_share_workers = 16
        > 
        > rootwrap_config = /etc/manila/rootwrap.conf
        > api_paste_config = /etc/manila/api-paste.ini
        > auth_strategy = keystone
        > 
        > ## RabbitMQ RPC
        > executor_thread_pool_size = 64
        > rpc_response_timeout = 60
        > 
        > transport_url = rabbit://manila:MANILA_MQPASS@RABBITMQ_IP1:5672,manila:MANILA_MQPASS@RABBITMQ_IP2:5672,manila:MANILA_MQPASS@RABBITMQ_IP3:5672//manila
        > 
        > ## Quota
        > quota_shares = -1
        > quota_snapshots = -1
        > quota_gigabytes = -1
        > quota_snapshot_gigabytes = -1
        > quota_share_networks = -1
        > 
        > os_region_name = RegionOne
        > 
        > storage_availability_zone = nova
        > 
        > client_socket_timeout = 900
        > 
        > enabled_share_protocols = NFS
        > 
        > ssh_conn_timeout = 30
        > ssh_min_pool_conn = 1
        > ssh_max_pool_conn = 1
        > 
        > enabled_share_backends = cephfsnfs
        > 
        > # All given backend(s)
        > [cephfsnfs]
        > driver_handles_share_servers = False
        > share_backend_name = CEPHFSNFS
        > share_driver = manila.share.drivers.cephfs.driver.CephFSDriver
        > cephfs_protocol_helper_type = NFS
        > cephfs_conf_path = /etc/ceph/ceph.conf
        > cephfs_auth_id = manila
        > cephfs_cluster_name = ceph
        > cephfs_enable_snapshots = False
        > ganesha_rados_store_enable = True
        > ganesha_rados_store_pool_name = cephfs_data
        > cephfs_ganesha_server_is_remote = True
        > cephfs_ganesha_server_ip = GANESHA_IP  # will be exported
        > cephfs_ganesha_server_username = root
        > cephfs_ganesha_path_to_private_key = /etc/manila/.ssh/manila_rsa
        > 
        > [database]
        > connection = mysql+pymysql://manila:MANILA_DBPASS@DB_IP/manila?charset=utf8
        > 
        > [oslo_messaging_rabbit]
        > ssl = False
        > 
        > [oslo_messaging_notifications]
        > driver = messagingv2
        > transport_url = rabbit://manila:MANILA_MQPASS@RABBITMQ_IP1:5672,manila:MANILA_MQPASS@RABBITMQ_IP2:5672,manila:MANILA_MQPASS@RABBITMQ_IP3:5672//manila
        > 
        > [oslo_concurrency]
        > lock_path = /var/lock/manila
        > 
        > [profiler]
        > enabled = False
        > trace_sqlalchemy = False
        > hmac_keys = MANIAL_HMAC_KEY
        > 
        > [keystone_authtoken]
        > insecure = False
        > auth_type = password
        > auth_url = http://CONTROLLER:35357
        > auth_uri = http://CONTROLLER:5000
        > project_domain_id = default
        > user_domain_id = default
        > project_name = service
        > username = manila
        > password = MANILA_SVCPASS
        > region_name = RegionOne
        > 
        > memcached_servers = MEMCACHED_IP1:11211,MEMCACHED_IP2:11211,MEMCACHED_IP3:11211
        > 
        > token_cache_time = 300
        > 
        > # if your memcached server is shared, use these settings to avoid cache poisoning
        > memcache_security_strategy = ENCRYPT
        > memcache_secret_key = MEMCACHED_SECRET_KEY
        > 
        > [neutron]
        > auth_type = password
        > auth_url = http://CONTROLLER:35357/v3
        > region_name = RegionOne
        > project_domain_id = default
        > user_domain_id = default
        > project_name = service
        > username = neutron
        > password = NEUTRON_SVCPASS
        > endpoint_type = internal
        > 
        > [nova]
        > auth_type = password
        > auth_url = http://CONTROLLER:35357/v3
        > region_name = RegionOne
        > project_domain_id = default
        > user_domain_id = default
        > project_name = service
        > username = nova
        > password = NOVA_SVCPASS
        > endpoint_type = internal
        > 
        > [cinder]
        > auth_type = password
        > auth_url = http://CONTROLLER:35357/v3
        > region_name = RegionOne
        > project_domain_id = default
        > user_domain_id = default
        > project_name = service
        > username = cinder
        > password = CINDER_SVCPASS
        > endpoint_type = internal
        > ```

    - Ganesha 노드 SSH 통신을 위한 Key 생성 및 설치
    
        manila-share는 NFS-Ganesha가 원격 호스트에 구성되어 있는 경우에 SSH로 접속하여 NFS Export 정보를 설정합니다. 패스워드를 사용할 수도 있지만 여기서는 키 파일을 사용합니다.

        ```
        install -d -m 0700 -o manila -g manila /etc/manila/.ssh
        sudo -u manila bash -c "ssh-keygen -f /etc/manila/.ssh/manila_rsa  -N ''"
        ```
        ```
        ssh-copy-id -i /etc/manila/.ssh/manila_rsa.pub GANESHA_IP
        ```
    
    - Systemd Unit 파일 생성
    
        ```
        vi /etc/systemd/system/manila-api.service
        ```
        > ```
        > [Unit]
        > Description=manila openstack service
        > After=syslog.target
        > After=network.target
        > 
        > [Service]
        > Type=simple
        > User=manila
        > Group=manila
        > 
        > ExecStart=/openstack/venvs/manila/bin/uwsgi --ini /etc/uwsgi/manila-api.ini --logto /var/log/manila/manila-api.log
        > ExecReload=/openstack/venvs/manila/bin/uwsgi --reload /var/run/manila-api/manila-api.pid
        > 
        > # Give a reasonable amount of time for the server to start up/shut down
        > TimeoutSec=120
        > Restart=on-failure
        > RestartSec=2
        > 
        > # This creates a specific slice which all manila services will operate from
        > #  The accounting options give us the ability to see resource usage through
        > #  the `systemd-cgtop` command.
        > Slice=manila.slice
        > CPUAccounting=true
        > BlockIOAccounting=true
        > MemoryAccounting=false
        > TasksAccounting=true
        > 
        > [Install]
        > WantedBy=multi-user.target
        > ```

        ```
        vi /etc/systemd/system/manila-scheduler.service
        ```
        > ```
        > [Unit]
        > Description=manila openstack service
        > After=syslog.target
        > After=network.target
        > 
        > [Service]
        > Type=simple
        > User=manila
        > Group=manila
        > 
        > ExecStart=/openstack/venvs/manila/bin/manila-scheduler --log-file=/var/log/manila/manila-scheduler.log
        > ExecReload=/bin/kill -HUP $MAINPID
        > 
        > # Give a reasonable amount of time for the server to start up/shut down
        > TimeoutSec=120
        > Restart=on-failure
        > RestartSec=2
        > 
        > # This creates a specific slice which all manila services will operate from
        > #  The accounting options give us the ability to see resource usage through
        > #  the `systemd-cgtop` command.
        > Slice=manila.slice
        > CPUAccounting=true
        > BlockIOAccounting=true
        > MemoryAccounting=false
        > TasksAccounting=true
        > 
        > [Install]
        > WantedBy=multi-user.target
        > ```

        ```
        vi /etc/systemd/system/manila-share.service
        ```
        > ```
        > [Unit]
        > Description=manila openstack service
        > After=syslog.target
        > After=network.target
        > 
        > [Service]
        > Type=simple
        > User=manila
        > Group=manila
        > 
        > ExecStart=/openstack/venvs/manila/bin/manila-share --log-file=/var/log/manila/manila-share.log
        > ExecReload=/bin/kill -HUP $MAINPID
        > 
        > # Give a reasonable amount of time for the server to start up/shut down
        > TimeoutSec=120
        > Restart=on-failure
        > RestartSec=2
        > 
        > # This creates a specific slice which all manila services will operate from
        > #  The accounting options give us the ability to see resource usage through
        > #  the `systemd-cgtop` command.
        > Slice=manila.slice
        > CPUAccounting=true
        > BlockIOAccounting=true
        > MemoryAccounting=false
        > TasksAccounting=true
        > 
        > [Install]
        > WantedBy=multi-user.target
        > ```
        
        ```
        systemctl daemon-reload
        ```